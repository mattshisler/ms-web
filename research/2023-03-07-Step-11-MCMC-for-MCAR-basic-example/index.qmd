---
title: "Step 11 - A Bayesian HM for multivariate Guassian data and MCAR prior - derivation of full conditionals and comments on computing"
description: "Previously we introduced the MCAR model and simulated data from it. Now we will focus on fitting a Bayesian MCAR model to multivariate areal data using MCMC. It will be a naive pedagogical approach."
author:
  - name: Matthew Shisler
    affiliation: North Carloina State University - Department of Statistics
    affiliation-url: https://statistics.sciences.ncsu.edu/ 
date: "3/7/2023"
categories: [Bayesian, MCMC, Spatial, MCAR] # self-defined categories
draft: false 
format:
  html: 
    code-fold: true
execute: 
  cache: false
  freeze: false
---


```{r}
#| label: load-packages
#| output: false
#| code-summary: "Code: Load the packages"

library(tidyverse)
library(igraph)
library(viridis)
```

## Intro

In this post we will code an MCMC sampler for a Bayesian hierarchical model with an MCAR prior specified in the second stage. For simplicity, we will consider the case common spatial strength parameter $\rho$.

Let $\mathcal{D}$ be a spatial domain partitioned into $n$ areal units indexed by $i$. Following the notation of Step 3 (link), let $\boldsymbol\delta_i$ be a multivariate ($p \times 1$) response vector with expected value
$$
\text{E}(\boldsymbol\delta_i)  = \boldsymbol{\mathcal{Z}}_i \boldsymbol\beta + \boldsymbol\phi_i
$$
and covariance
$$

$$

$$
\boldsymbol\delta_i = \boldsymbol{\mathcal{Z}}_i\boldsymbol\beta + \boldsymbol\phi_i + \boldsymbol\epsilon_i
$$
where $\boldsymbol\epsilon_i \sim \text{N}\left(\boldsymbol 0, \boldsymbol\Omega\right)$.

$$
\begin{align*}
\boldsymbol\delta_i &\sim \text{Normal}_{p}\left(\boldsymbol{\mathcal{Z}}_i\boldsymbol\beta + \boldsymbol\phi_i, \,  \boldsymbol\Omega\right)\\
\boldsymbol\phi_i|\boldsymbol\phi_{j\ne i},\boldsymbol\Lambda &\sim \text{Normal}_p\left(\rho\sum_{i \sim j}\mathbf{B}_{ij}\boldsymbol\phi_j, \, w^{-1}_{i+}\boldsymbol\Lambda\right)\\
\boldsymbol\beta &\sim \text{Normal}_{qp}(\boldsymbol\mu, \, \boldsymbol\Gamma)\\
\omega_{kk} &\sim \text{InvGamm}(a_k, \, b_k)\\
\boldsymbol\Lambda &\sim \text{InvWish}()\\
\rho &\sim \text{Unif}(0, \,1)
\end{align*}
$$

In another way,

$$
\begin{align*}
\boldsymbol\delta_i &\sim \text{Normal}_p\left(\boldsymbol{\mathcal{Z}}_i\boldsymbol\beta + \boldsymbol\phi_i, \;  \boldsymbol\Omega\right)\\
\boldsymbol\beta &\sim \text{Normal}_{qp}\left(\boldsymbol\mu, \boldsymbol\Gamma\right)\\
\boldsymbol\phi' &\sim \text{Normal}_{np}\left(\boldsymbol 0, (\mathbf{D-\rho\mathbf{W}})^{-1} \otimes \boldsymbol\Lambda\right)\\
\omega_{kk} &\sim \text{InvGamm}(a_k, b_k)\\
\boldsymbol\Lambda &\sim \text{InvWish}()\\
\rho &\sim \text{Unif}(0,1)
\end{align*}
$$

In this specification we take elements of $\boldsymbol\delta_i$ to be independent which in general need not be the case.


Start with the full conditional for $\boldsymbol\beta$.
$$
\begin{align*}
p(\boldsymbol\beta \,|\, \text{rest}) &\propto p(\{\boldsymbol\delta_i\}, \boldsymbol\phi, \boldsymbol\beta, \boldsymbol\Omega, \boldsymbol\Lambda, \rho)\\
&\propto p(\{\boldsymbol\delta_i\} \,|\, \boldsymbol\beta, \boldsymbol\phi, \boldsymbol\Omega)p(\boldsymbol\beta)\\
&= \left[\prod_{i=1}^n p(\boldsymbol\delta_i \,|\, \boldsymbol\beta,\boldsymbol\phi_i,\boldsymbol\Omega)\right]p(\boldsymbol\beta)\\
&\propto \exp\left\{-\frac{1}{2}\sum_{i=1}^n\left[\boldsymbol\delta_i-(\boldsymbol{\mathcal{Z}}_i\boldsymbol\beta + \boldsymbol\phi_i)\right]^T\boldsymbol\Omega^{-1}\left[\boldsymbol\delta_i-(\boldsymbol{\mathcal{Z}}_i\boldsymbol\beta + \boldsymbol\phi_i)\right]\right\}\\
&\quad \, \times \exp\left\{-\frac{1}{2}\left[\boldsymbol\beta-\boldsymbol\mu\right]^T\boldsymbol\Gamma^{-1}\left[\boldsymbol\beta-\boldsymbol\mu\right]\right\}\\
&\propto \exp\left\{-\frac{1}{2}\left[\boldsymbol\beta^T\left(\sum_{i=1}^n\boldsymbol{\mathcal{Z}}_i^T\boldsymbol\Omega^{-1}\boldsymbol{\mathcal{Z}}_i\right)\boldsymbol\beta - 2\left(\sum_{i=1}^n(\boldsymbol\delta_i-\boldsymbol\phi_i)^T\boldsymbol\Omega^{-1}\boldsymbol{\mathcal{Z}}_i\right)\boldsymbol\beta\right]\right\}\\
&\quad \, \times \exp\left\{-\frac{1}{2}\left[\boldsymbol\beta^T\boldsymbol\Gamma^{-1}\boldsymbol\beta - 2\boldsymbol\mu^T\boldsymbol\Gamma^{-1}\boldsymbol\beta\right]\right\}\\
&\propto \exp\left\{-\frac{1}{2}\left[\boldsymbol\beta^T\left(\sum_{i=1}^n\boldsymbol{\mathcal{Z}}_i^T\boldsymbol\Omega^{-1}\boldsymbol{\mathcal{Z}}_i + \boldsymbol\Gamma^{-1}\right)\boldsymbol\beta - 2\left(\sum_{i=1}^n(\boldsymbol\delta_i-\boldsymbol\phi_i)^T\boldsymbol\Omega^{-1}\boldsymbol{\mathcal{Z}}_i + \boldsymbol\mu^T\boldsymbol\Gamma^{-1}\right)\boldsymbol\beta\right]\right\}
\end{align*}
$$
Thus,
$$
\begin{align*}
\boldsymbol\beta\,|\,\text{rest} &\sim \text{Normal}_{qp}(\mathbf{V}_\beta^{-1}\mathbf{M}_\beta, \mathbf{V}_\beta^{-1})\\
\mathbf{V}_\beta &= \sum_{i=1}^n\boldsymbol{\mathcal{Z}}^T_i\mathbf{\Omega}^{-1}\boldsymbol{\mathcal{Z}}_i + \mathbf{\Omega}^{-1}\\
\mathbf{M}_\beta &= \sum_{i=1}^n\boldsymbol{\mathcal{Z}}^T_i\mathbf{\Omega}^{-1}(\boldsymbol\delta_i-\boldsymbol\phi_i) + \mathbf{\Omega}^{-1}\boldsymbol\mu
\end{align*}
$$

Next we must determine the full conditional distribution for the spatial random vector. There are two approaches here, we could either derive full conditionals for $\boldsymbol\phi_i$ and draw samples in $n$ sub-blocks of parameters, or we could derive the full conditional for $\boldsymbol\phi'$ and update all $\boldsymbol\phi_i$ in a single block. It is hard to say which would be computationally preferable. The latter seems more interesting, though, so let's try to tackle that.

The trickiness of updating $\boldsymbol\phi'$ as a single block is due to our model specification for $\boldsymbol\delta_i$. The likelihood for $\boldsymbol\delta_i$ is not compatible with the prior on $\boldsymbol\phi'$ because the spatial term in the former is specified in terms of $p \times 1$ vectors while in the latter spatial term is a $np \times 1$ vector.

We could either construct the joint distribution of the $\boldsymbol\delta_i$ vectors or we could try to write $\boldsymbol\phi_i$ in terms of $\boldsymbol\phi'$ and substitute into the corresponding $\boldsymbol\delta_i$ distributions. 

Let,
$$
\boldsymbol\Delta = 
\begin{pmatrix}
\delta_{11} & \dots & \delta_{1p}\\
\delta_{21} & \dots & \delta_{2p}\\
\vdots & \vdots & \vdots\\
\delta_{n1} & \dots & \delta_{np}\\
\end{pmatrix} =
\begin{pmatrix}
\boldsymbol\delta_1^T\\
\boldsymbol\delta_2^T\\
\vdots\\
\boldsymbol\delta_n^T\\
\end{pmatrix}
$$

Then define $\boldsymbol\delta' = \text{vec}(\boldsymbol\Delta^T)$. Since $\boldsymbol\delta_i$ are conditionally independent, the joint distribution for $\boldsymbol\delta'$ is

$$
\boldsymbol\delta' \sim \text{Normal}_{np} 
\left(
\begin{pmatrix}
\boldsymbol{\mathcal{Z}}_1\boldsymbol\beta\\
\boldsymbol{\mathcal{Z}}_2\boldsymbol\beta\\
\vdots \\
\boldsymbol{\mathcal{Z}}_n\boldsymbol\beta\\
\end{pmatrix} + \boldsymbol\phi', \;
\mathbf{I}_n \otimes \boldsymbol\Omega
\right)
$$
Again, the purpose of constructing the joint distribution in this way was to ensure the mean is in terms of $\boldsymbol\phi'$. But now the fixed effects term is a bit awkward. Let's avoid that temporarily by letting
$$
\mathbf{A} = 
\begin{pmatrix}
\boldsymbol{\mathcal{Z}}_1\boldsymbol\beta\\
\boldsymbol{\mathcal{Z}}_2\boldsymbol\beta\\
\vdots \\
\boldsymbol{\mathcal{Z}}_n\boldsymbol\beta\\
\end{pmatrix}.
$$
Then if we proceed in deriving the full conditional for $\boldsymbol\phi'$, we will have

$$
\begin{align*}
p(\boldsymbol\phi' \,|\, \text{rest}) &\propto p(\boldsymbol\delta', \boldsymbol\phi', \boldsymbol\beta, \boldsymbol\Omega, \boldsymbol\Lambda, \rho)\\
&\propto p(\{\boldsymbol\delta' \,|\, \boldsymbol\beta, \boldsymbol\phi', \boldsymbol\Omega)p(\boldsymbol\phi')\\
&\propto \exp\left\{-\frac{1}{2}\left[\boldsymbol\delta'-(\mathbf{A} + \boldsymbol\phi')\right]^T\left(\mathbf{I}_n \otimes \boldsymbol\Omega\right)^{-1}\left[\boldsymbol\delta_i-(\mathbf{A} + \boldsymbol\phi')\right]\right\}\\
&\quad \, \times \exp\left\{-\frac{1}{2}(\boldsymbol\phi')^T\left((\mathbf{D-\rho\mathbf{W}}) \otimes \boldsymbol\Lambda^{-1}\right)\boldsymbol\phi'\right\}\\
&\propto \exp\left\{-\frac{1}{2}\left[(\boldsymbol\phi')^T\left(\mathbf{I}_n \otimes \boldsymbol\Omega\right)^{-1}\boldsymbol\phi' - 2\left((\boldsymbol\delta'-\mathbf{A})^T\left(\mathbf{I}_n \otimes \boldsymbol\Omega\right)^{-1}\right)\boldsymbol\phi'\right]\right\}\\
&\quad \, \times \exp\left\{-\frac{1}{2}(\boldsymbol\phi')^T\left((\mathbf{D-\rho\mathbf{W}}) \otimes \boldsymbol\Lambda^{-1}\right)\boldsymbol\phi'\right\}\\
&\propto \exp\left\{-\frac{1}{2}\left[(\boldsymbol\phi')^T\left(\left(\mathbf{I}_n \otimes \boldsymbol\Omega\right)^{-1} + \left((\mathbf{D-\rho\mathbf{W}}) \otimes \boldsymbol\Lambda^{-1}\right)\right)\boldsymbol\phi' - 2\left((\boldsymbol\delta'-\mathbf{A})^T\left(\mathbf{I}_n \otimes \boldsymbol\Omega\right)^{-1}\right)\boldsymbol\phi'\right]\right\}
\end{align*}
$$
Thus,

$$
\begin{align*}
\boldsymbol\phi'\,|\,\text{rest} &\sim \text{Normal}_{np}(\mathbf{V}_{\phi'}^{-1}\mathbf{M}_{\phi'}, \mathbf{V}_{\phi'}^{-1})\\
\mathbf{V}_{\phi'} &= \left(\mathbf{I}_n \otimes \boldsymbol\Omega\right)^{-1} + \left((\mathbf{D-\rho\mathbf{W}}) \otimes \boldsymbol\Lambda^{-1}\right)\\
\mathbf{M}_{\phi'} &= \left(\mathbf{I}_n \otimes \boldsymbol\Omega\right)^{-1}(\boldsymbol\delta'-\mathbf{A})
\end{align*}
$$

This full conditional looks to be pretty clean, though we will need to consider efficient ways to compute $\mathbf{A}$. Before moving on, let's explore an alternative derivation for the full conditional of $\boldsymbol\phi'$.

If we instead wrote $\boldsymbol\phi_i$ in terms of $\boldsymbol\phi'$ when describing the distribution of $\boldsymbol\delta_i$? Consider the way in which one "extracts" a sub-vector of elements from a vector. We know there exists a $p \times np$ matrix \mathbf{U}_i which will "extract" the $p \times 1$ $\boldsymbol\phi_i$ vector from the $np \times 1$ $\boldsymbol\phi'$ vector. This $\mathbf{U}_i$ matrix will have all elements equal to $0$ except for $p$ columns forming a $p \times p$ identity matrix. The position of this $p \times p$ identity matrix in $\mathbf{U}_i$ determines which $\boldsymbol\phi_i$ to "extract" from $\boldsymbol\phi'$. In order to extract $\boldsymbol\phi_i$, then the $p \times p$ identity matrix must begin at column $(i-1)p + 1$ in $\mathbf{U}_i$

$$
\begin{align*}
\boldsymbol\phi_i &= 
\mathbf{U}_i\boldsymbol\phi'\\
&= \begin{pmatrix}
\boldsymbol{0}_p & \dots & \boldsymbol{0}_p & \mathbf{I}_p & \boldsymbol{0}_p & \dots & \boldsymbol{0}_p
\end{pmatrix}
\boldsymbol\phi'
\end{align*}
$$
where $\boldsymbol 0_p$ is a $p \times p$ matrix of $0$'s. Now we can write

$$
\boldsymbol\delta_i \sim \text{Normal}_p\left(\boldsymbol{\mathcal{Z}}_i\boldsymbol\beta + \mathbf{U}_i\boldsymbol\phi', \;  \boldsymbol\Omega\right)
$$
which will facilitate the derivation of the full conditional for $\boldsymbol\phi'$.

$$
\begin{align*}
p(\boldsymbol\phi' \,|\, \text{rest}) &\propto p(\{\boldsymbol\delta_i\}, \boldsymbol\phi', \boldsymbol\beta, \boldsymbol\Omega, \boldsymbol\Lambda, \rho)\\
&\propto p(\{\boldsymbol\delta_i\} \,|\, \boldsymbol\beta, \boldsymbol\phi', \boldsymbol\Omega)p(\boldsymbol\phi')\\
&= \left[\prod_{i=1}^n p(\boldsymbol\delta_i \,|\, \boldsymbol\beta,\boldsymbol\phi',\boldsymbol\Omega)\right]p(\boldsymbol\phi')\\
&\propto \exp\left\{-\frac{1}{2}\sum_{i=1}^n\left[\boldsymbol\delta_i-(\boldsymbol{\mathcal{Z}}_i\boldsymbol\beta + \mathbf{U}_i\boldsymbol\phi')\right]^T\boldsymbol\Omega^{-1}\left[\boldsymbol\delta_i-(\boldsymbol{\mathcal{Z}}_i\boldsymbol\beta + \mathbf{U}_i\boldsymbol\phi')\right]\right\}\\
&\quad \, \times \exp\left\{-\frac{1}{2}(\boldsymbol\phi')^T\left((\mathbf{D-\rho\mathbf{W}}) \otimes \boldsymbol\Lambda^{-1}\right)\boldsymbol\phi'\right\}\\
&\propto \exp\left\{-\frac{1}{2}\left[(\boldsymbol\phi')^T\left(\sum_{i=1}^n\mathbf{U}_i^T\boldsymbol\Omega^{-1}\mathbf{U}_i\right)\boldsymbol\phi' - 2\left(\sum_{i=1}^n(\boldsymbol\delta_i-\boldsymbol{\mathcal{Z}}_i\boldsymbol\beta)^T\boldsymbol\Omega^{-1}\mathbf{U}_i\right)\boldsymbol\phi'\right]\right\}\\
&\quad \, \times \exp\left\{-\frac{1}{2}(\boldsymbol\phi')^T\left((\mathbf{D-\rho\mathbf{W}}) \otimes \boldsymbol\Lambda^{-1}\right)\boldsymbol\phi'\right\}\\
&\propto \exp\left\{-\frac{1}{2}\left[(\boldsymbol\phi')^T\left(\sum_{i=1}^n\mathbf{U}_i^T\boldsymbol\Omega^{-1}\mathbf{U}_i + \left((\mathbf{D-\rho\mathbf{W}}) \otimes \boldsymbol\Lambda^{-1}\right)\right)\boldsymbol\phi' - 2\left(\sum_{i=1}^n(\boldsymbol\delta_i-\boldsymbol{\mathcal{Z}}_i\boldsymbol\beta)^T\boldsymbol\Omega^{-1}\mathbf{U}_i\right)\boldsymbol\phi'\right]\right\}
\end{align*}
$$
Thus,
$$
\begin{align*}
\boldsymbol\phi'\,|\,\text{rest} &\sim \text{Normal}_{np}(\mathbf{V}_{\phi'}^{-1}\mathbf{M}_{\phi'}, \mathbf{V}_{\phi'}^{-1})\\
\mathbf{V}_{\phi'} &= \sum_{i=1}^n\mathbf{U}_i^T\boldsymbol\Omega^{-1}\mathbf{U}_i + \left((\mathbf{D-\rho\mathbf{W}}) \otimes \boldsymbol\Lambda^{-1}\right)\\
\mathbf{M}_{\phi'} &= \sum_{i=1}^n\mathbf{U}^T_i\mathbf{\Omega}^{-1}(\boldsymbol\delta_i-\boldsymbol{\mathcal{Z}}_i\boldsymbol\beta)
\end{align*}
$$





